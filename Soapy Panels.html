<!DOCTYPE html><html lang="en"><head><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Soapy Panels — Speech Bubble Editor</title><style>:root{--bg:#f7f8fb;--panel:#fff;--muted:#f3f4f7;--ink:#111;--ink-dim:#555a66;--radius:14px;--brand:#01151D;--accent:#F65485;--border:#d9dde6}*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 Inter, system-ui, -apple-system, Segoe UI, Arial, Roboto, \"Noto Sans\", sans-serif}.app{display:grid;grid-template-columns:1fr 6px 360px;grid-template-rows:auto 1fr;grid-template-areas:"header header header" "main split aside";gap:8px;height:100%;padding:12px}header{grid-area:header;display:flex;gap:12px;align-items:center;justify-content:flex-start;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:3px 10px;position:relative}header .brand{display:flex;align-items:center;gap:8px}header h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}.logo{width:56px;height:56px;display:block}.menubar{display:flex;gap:16px;margin-left:16px;white-space:nowrap}.menu-wrap{position:relative;display:inline-flex}.menu{appearance:none;background:transparent;border:0;color:#111;font-weight:700;font-size:17px;padding:6px 8px;border-radius:6px;cursor:pointer}.menu:hover{background:#f1f4fa}.dropdown{position:absolute;top:100%;left:0;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:6px;min-width:210px;z-index:50}[hidden]{display:none!important}.mi{display:block;width:100%;text-align:left;border:0;background:#fff;padding:8px 10px;border-radius:8px;cursor:pointer} .mi:hover:not(:disabled){background:#f3f6fb}.mi:disabled{opacity:.5;cursor:default}.sep{height:1px;background:#e3e7f1;margin:6px 4px}.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;min-height:0}.controls{display:flex;flex-direction:column;gap:10px}.section{background:var(--muted);border-radius:12px;padding:10px;border:1px solid var(--border)}.section h3{margin:0 0 8px 0;font-size:13px;color:#222;letter-spacing:.2px;text-transform:none}.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.row>*{flex:1}.row .tight{flex:0}button{appearance:none;border:1px solid var(--border);background:#fff;color:#111;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:600}button:hover{background:#f5f7fb}input[type=color]{height:32px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}input[type=number],select,textarea{width:100%;border:1px solid var(--border);background:#fff;color:#111;border-radius:10px;padding:7px 9px;font-size:13px}textarea{min-height:80px;resize:vertical}.canvas-wrap{position:relative;background:#fafbfe;border-radius:12px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;padding-left:32px;padding-top:24px}.drop{position:absolute;inset:0;display:grid;place-items:center;color:#666;pointer-events:none}.canvas-scroller{position:absolute;top:24px;left:32px;right:0;bottom:36px;overflow:auto}.canvas-inner{position:relative;margin:auto}#stage{background:transparent;display:block;touch-action:none;outline:none}#stage,#overlay{position:absolute;left:0;top:0;width:100%;height:100%;transform-origin:0 0}#overlay{pointer-events:none}#hitAnchors{position:absolute;left:0;top:0;width:100%;height:100%;z-index:9;pointer-events:none}.hitAnchor{position:absolute;border:2px dashed transparent;border-radius:10px;pointer-events:auto;cursor:move}.small{font-size:12px;color:#666}#splitter{grid-area:split;width:6px;cursor:col-resize;background:linear-gradient(180deg,#f1f3f7,#e9edf5);border:1px solid var(--border);border-radius:12px;position:relative}#splitter::after{content:"";position:absolute;left:50%;top:12px;bottom:12px;width:2px;transform:translateX(-50%);background:#cfd6e3;border-radius:2px;opacity:.8}.ruler-top{position:absolute;left:32px;right:0;top:0;height:24px;background:#f8fafc;border-bottom:1px solid var(--border);z-index:3}.ruler-left{position:absolute;top:24px;bottom:0;left:0;width:32px;background:#f8fafc;border-right:1px solid var(--border);z-index:3}.ruler-corner{position:absolute;left:0;top:0;width:32px;height:24px;background:#f0f3f8;border-right:1px solid var(--border);border-bottom:1px solid var(--border);z-index:4}
.canvas-footer{position:absolute;left:32px;right:0;bottom:0;height:36px;background:#fff;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:6px 10px;z-index:2}
.canvas-footer input[type=range]{width:160px}
.corner-wrap{position:absolute;left:50%;top:50%;width:100%;height:100%;transform:translate(-50%,-50%);transform-origin:50% 50%;pointer-events:none}
.corner-btn{position:absolute;width:26px;height:26px;border-radius:3px;pointer-events:auto;z-index:2;background:transparent;transform:translate(-50%,-50%)}
/* side handles */
.side-btn{position:absolute;width:22px;height:22px;border-radius:3px;pointer-events:auto;z-index:2;background:transparent;transform:translate(-50%,-50%)}
.side-btn[data-s="l"],.side-btn[data-s="r"]{cursor:ew-resize}
.side-btn[data-s="t"],.side-btn[data-s="b"]{cursor:ns-resize}
/* cursor per-corner */
.corner-btn[data-c="tl"],.corner-btn[data-c="br"]{cursor:nwse-resize}
.corner-btn[data-c="tr"],.corner-btn[data-c="bl"]{cursor:nesw-resize}
/* rotate handle button */
.rot-btn{position:absolute;left:50%;top:0%;width:22px;height:22px;border-radius:50%;transform:translate(-50%,-50%);pointer-events:auto;z-index:3;background:transparent;cursor:grab}
.rot-btn:active{cursor:grabbing}
/* collapsible right panel */
aside .section{overflow:hidden}
aside .section h3{display:flex;align-items:center;gap:6px}
aside .section h3 .tgl{all:unset;display:inline-grid;place-items:center;width:18px;height:18px;border-radius:4px;font-size:12px;line-height:1;cursor:pointer;color:#555}
aside .section h3 .tgl:hover{background:#e9edf5}
aside .section.collapsed{padding:4px 8px}
aside .section.collapsed h3{margin:0}
aside .section.collapsed>*:not(h3){display:none}
</style></head><body><div class="app"><header><div class="brand"><img class="logo" src="https://raw.githubusercontent.com/l67407523-design/crispy-octo-eureka/main/Soapy%20panel%20icon.png" alt="logo"/><h1>Soapy Panels</h1><nav class="menubar"><div class="menu-wrap"><button id="menu-file" class="menu" type="button">File</button><div id="dropdown-file" class="dropdown" hidden><button class="mi" id="mi-new">New Project</button><button class="mi" id="mi-open">Open Project</button><button class="mi" id="mi-load-img">Load Image…</button><div class="sep"></div><button class="mi" id="mi-save">Save Project</button><button class="mi" id="mi-exp-png">Export as PNG</button><button class="mi" id="mi-exp-jpg">Export as JPEG</button><div class="sep"></div><button class="mi" id="mi-lang" disabled>Language</button></div></div><div class="menu-wrap"><button id="menu-edit" class="menu" type="button">Edit</button><div id="dropdown-edit" class="dropdown" hidden><button class="mi" id="mi-undo">Undo</button><button class="mi" id="mi-redo">Redo</button><div class="sep"></div><button class="mi" id="mi-copy">Copy</button><button class="mi" id="mi-paste">Paste</button><button class="mi" id="mi-delete">Delete</button></div></div><div class="menu-wrap"><button class="menu" type="button">View</button></div><div class="menu-wrap"><button class="menu" type="button">Help</button></div></nav></div></header><input type="file" id="fileImage" accept="image/*" hidden/><div id="splitter"></div><aside class="panel" style="grid-area:aside">
  <div class="controls">
    <div class="section"><h3>Add bubble</h3>
      <div class="btn-group">
        <button id="addSpeech">Speech</button>
        <button id="addThought">Thought</button>
        <button id="addShout">Shout</button>
      </div>
    </div>

    <div class="section" id="pickPanel"><h3>Pick a bubble</h3>
      <div class="row">
        <select id="bubblePicker"></select>
        <button id="btnNewBubble" class="ghost tight" title="Create and select a new Speech bubble">+ New</button>
      </div>
    </div>

    <div class="section" id="selPanel" style="display:none"><h3>Selected bubble</h3>
      <div class="row">
        <button id="btnUp" title="Bring forward">▲</button>
        <button id="btnDown" title="Send backward">▼</button>
        <button id="btnDuplicate">Duplicate</button>
        <button id="btnDelete" class="warn">Delete</button>
      </div>
      <div class="row"><label class="tight small">Type</label>
        <select id="propType">
          <option value="speech">Speech</option>
          <option value="thought">Thought</option>
          <option value="shout">Shout</option>
        </select>
      </div>
      <div class="row"><label class="tight small">Text</label>
        <textarea id="propText" placeholder="Type your dialogue…"></textarea>
      </div>
      <div class="row"><label class="tight small">Font</label>
        <select id="propFont">
          <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Impact / Narrow Bold</option>
          <option value="Arial Black, Gadget, sans-serif">Arial Black</option>
          <option value="'Trebuchet MS', Arial, sans-serif">Trebuchet</option>
          <option value="Arial, Helvetica, sans-serif">Arial</option>
          <option value="Roboto, Arial, sans-serif">Roboto</option>
          <option value="'Noto Sans', Arial, sans-serif">Noto Sans</option>
          <option value="'Noto Sans JP', 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif">Noto Sans JP</option>
          <option value="Georgia, serif">Georgia</option>
        </select>
      </div>
      <div class="row"><label class="tight small">Size</label>
        <input type="number" id="propFontSize" min="8" max="200" value="40"/>
        <label class="tight small">Align</label>
        <select id="propAlign">
          <option value="center">Center</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
      <div class="row"><label class="tight small">Bubble</label>
        <input type="color" id="propFill" value="#ffffff"/>
        <label class="tight small">Border</label>
        <input type="color" id="propStroke" value="#000000"/>
        <label class="tight small">W</label>
        <input type="number" id="propStrokeW" min="0" max="40" value="6"/>
      </div>
      <div class="row"><label class="tight small">Text</label>
        <input type="color" id="propTextFill" value="#000000"/>
        <label class="tight small">Outline</label>
        <input type="color" id="propTextStroke" value="#ffffff"/>
        <label class="tight small">W</label>
        <input type="number" id="propTextStrokeW" min="0" max="30" value="6"/>
      </div>
      <div class="row"><label class="tight small"><input type="checkbox" id="propTailEnabled" checked/> Tail</label>
        <label class="tight small">Tail W</label>
        <input type="number" id="propTailW" min="5" max="300" value="40"/>
        <label class="tight small">Tail L</label>
        <input type="number" id="propTailL" min="5" max="600" value="80"/>
      </div>
      <div class="row"><label class="tight small">Padding</label>
        <input type="number" id="propPadding" min="0" max="100" value="18"/>
        <label class="tight small">Rotation</label>
        <input type="number" id="propRot" min="-180" max="180" value="0"/>
      </div>
    </div>

    <div class="section" id="movePanel" style="display:none"><h3>Move</h3>
      <div class="row"><label class="tight small">X</label><input type="number" id="propX" step="1"/>
        <label class="tight small">Y</label><input type="number" id="propY" step="1"/>
      </div>
    </div>

    <div class="section" id="sizePanel" style="display:none"><h3>Size</h3>
      <div class="row"><label class="tight small">W</label><input type="number" id="propW" step="1" min="40"/>
        <label class="tight small">H</label><input type="number" id="propH" step="1" min="40"/>
      </div>
    </div>
  </div>
</aside><main class="panel canvas-wrap" id="canvasWrap" style="grid-area:main"><canvas id="rulerTop" class="ruler-top"></canvas><canvas id="rulerLeft" class="ruler-left"></canvas><div class="ruler-corner"></div><div class="canvas-scroller" id="scroller"><div id="canvasInner" class="canvas-inner"><canvas id="stage" width="1280" height="720" tabindex="0"></canvas><canvas id="overlay" width="1280" height="720"></canvas><div id="hitAnchors"></div></div></div><div class="canvas-footer" id="canvasFooter"><span class="small">Zoom</span><input type="range" id="zoom" min="10" max="300" value="100"/><span id="zoomLabel" class="small" style="width:48px;text-align:right">100%</span><span class="small">Canvas</span><input type="color" id="bgColor" value="#000000"/><span class="small">Opacity</span><input type="number" id="bgOpacity" min="0" max="1" step="0.05" value="1"/><span class="small" style="opacity:.6;margin-left:8px;margin-right:4px">|</span><span id="status" class="small">No image loaded</span></div><div class="drop" id="dropHint"><div>Drop an image here or use <strong>File → Load Image…</strong></div></div></main></div><script>(function(){function $(s){return document.querySelector(s)}var canvas=$('#stage');if(!canvas)return;var ctx=canvas.getContext('2d'),ov=$('#overlay'),octx=ov.getContext('2d'),statusEl=$('#status'),wrap=$('#canvasWrap'),scroller=$('#scroller'),inner=$('#canvasInner'),dropHint=$('#dropHint');
var rTop=$('#rulerTop'), rLeft=$('#rulerLeft'), footer=$('#canvasFooter');ov.style.pointerEvents='none';var anchorsRoot=$('#hitAnchors'),anchors={};var state={bg:{image:null,w:1280,h:720,color:'#000',opacity:1,imageSrc:null},zoom:1,bubbles:[],selectedId:null,drag:null,activePointer:null};function uid(){return Math.random().toString(36).slice(2)}function clamp(v,a,b){return Math.max(a,Math.min(b,v))}function deg2rad(a){return a*Math.PI/180}function clear(c){c.clearRect(0,0,c.canvas.width,c.canvas.height)}function rotatePoint(px,py,cx,cy,ang){var s=Math.sin(ang),co=Math.cos(ang),dx=px-cx,dy=py-cy;return{x:cx+dx*co-dy*s,y:cy+dx*s+dy*co}}function invRotatePoint(px,py,cx,cy,ang){return rotatePoint(px,py,cx,cy,-ang)}function nearestPointOnRect(x,y,w,h,tx,ty){var cx=x+w/2,cy=y+h/2,dx=tx-cx,dy=ty-cy,absDx=Math.abs(dx),absDy=Math.abs(dy),px,py,hw=w/2,hh=h/2,sx=dx===0?0:dx/absDx,sy=dy===0?0:dy/absDy;if(absDx*hh>absDy*hw){px=cx+sx*hw;py=cy+dy*(hw/absDx)}else{px=cx+dx*(hh/absDy);py=cy+sy*hh}return{x:px,y:py}}function makeBubble(t){var w=Math.min(400,state.bg.w*.5),h=160,x=(state.bg.w-w)/2,y=(state.bg.h-h)/2,id=uid();return{id:id,type:t||'speech',x:x,y:y,w:w,h:h,rot:0,text:(t==='shout'?'AAAAAH!':(t==='thought'?'Hmm…':'Hello!')),font:"Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif",fontSize:40,align:'center',padding:18,fill:'#fff',stroke:'#000',strokeW:6,textFill:'#000',textStroke:'#fff',textStrokeW:6,tail:{enabled:true,lx:0,ly:h/2+80,width:40,length:80}}}function drawRoundedRectPath(c,x,y,w,h,r){var rr=Math.min(r,Math.min(w,h)/2);c.beginPath();c.moveTo(x+rr,y);c.arcTo(x+w,y,x+w,y+h,rr);c.arcTo(x+w,y+h,x,y+h,rr);c.arcTo(x,y+h,x,y,rr);c.arcTo(x,y,x+w,y,rr);c.closePath()}function drawStarburstPath(c,cx,cy,w,h,sp){sp=sp||14;var R=Math.min(w,h)/2,r=R*.6;c.beginPath();for(var i=0;i<sp*2;i++){var ang=(i*Math.PI)/sp,rad=(i%2===0?R:r),x=cx+Math.cos(ang)*rad,y=cy+Math.sin(ang)*rad;if(i===0)c.moveTo(x,y);else c.lineTo(x,y)}c.closePath()}function drawCloudPath(c,x,y,w,h){var r=Math.min(w,h)/6,cx=x+w/2,cy=y+h/2,n=10;c.beginPath();for(var i=0;i<n;i++){var ang=i/n*Math.PI*2,px=cx+Math.cos(ang)*(w/2-r),py=cy+Math.sin(ang)*(h/2-r);c.save();c.translate(px,py);c.arc(0,0,r,0,Math.PI*2);c.restore();if(i===0)c.moveTo(px+r,py)}c.closePath()}function wrapLines(c,t,maxW){var words=(t||'').split(' '),lines=[],cur='';for(var i=0;i<words.length;i++){var w=words[i],test=cur?cur+' '+w:w;if(c.measureText(test).width<=maxW||!cur)cur=test;else{lines.push(cur);cur=w}}if(cur)lines.push(cur);return lines}function drawBubble(c,b){var cx=b.x+b.w/2,cy=b.y+b.h/2;c.save();c.translate(cx,cy);c.rotate(deg2rad(b.rot));var x=-b.w/2,y=-b.h/2,w=b.w,h=b.h,tipLocal={x:b.tail.lx,y:b.tail.ly},attachLocal=nearestPointOnRect(x,y,w,h,tipLocal.x,tipLocal.y);c.lineJoin='round';c.lineCap='round';c.beginPath();if(b.type==='speech')drawRoundedRectPath(c,x,y,w,h,Math.min(20,Math.min(w,h)/4));else if(b.type==='thought')drawCloudPath(c,x,y,w,h);else drawStarburstPath(c,0,0,w,h,14);c.fillStyle=b.fill;c.fill();if(b.strokeW>0){c.lineWidth=b.strokeW;c.strokeStyle=b.stroke;c.stroke()}if(b.tail.enabled){if(b.type==='thought'){for(var i=1;i<=3;i++){var t=i/4,px=attachLocal.x+(tipLocal.x-attachLocal.x)*t,py=attachLocal.y+(tipLocal.y-attachLocal.y)*t;c.beginPath();c.arc(px,py,(5-i)*3/2,0,Math.PI*2);c.fillStyle=b.fill;c.fill();if(b.strokeW>0){c.lineWidth=b.strokeW*.6;c.strokeStyle=b.stroke;c.stroke()}}}else{var ang=Math.atan2(tipLocal.y-attachLocal.y,tipLocal.x-attachLocal.x),half=b.tail.width/2,nx=Math.cos(ang+Math.PI/2)*half,ny=Math.sin(ang+Math.PI/2)*half;c.beginPath();c.moveTo(attachLocal.x+nx,attachLocal.y+ny);c.lineTo(tipLocal.x,tipLocal.y);c.lineTo(attachLocal.x-nx,attachLocal.y-ny);c.closePath();c.fillStyle=b.fill;c.fill();if(b.strokeW>0){c.lineWidth=b.strokeW;c.strokeStyle=b.stroke;c.stroke()}}}var pad=b.padding,tx=x+pad,ty=y+pad,tw=w-2*pad,th=h-2*pad;c.font='700 '+b.fontSize+'px '+b.font;c.textBaseline='top';c.textAlign=b.align;var lines=wrapLines(c,b.text,tw),ay=ty,lh=b.fontSize*1.15,totalH=lines.length*lh;ay=ty+(th-totalH)/2;for(var li=0;li<lines.length;li++){var line=lines[li],ax=(b.align==='center')?(x+w/2):(b.align==='left'?tx:(x+w-pad));if(b.textStrokeW>0){c.lineWidth=b.textStrokeW;c.strokeStyle=b.textStroke;c.strokeText(line,ax,ay)}c.fillStyle=b.textFill;c.fillText(line,ax,ay);ay+=lh}c.restore()}function drawHandles(c,b){
  c.save(); c.translate(b.x+b.w/2,b.y+b.h/2); c.rotate(deg2rad(b.rot));
  var x=-b.w/2,y=-b.h/2,w=b.w,h=b.h; 
  c.strokeStyle='rgba(0,0,0,.6)'; c.lineWidth=1; c.setLineDash([6,4]); c.strokeRect(x,y,w,h); c.setLineDash([]);
  var hs=12, corners=[[x,y],[x+w,y],[x+w,y+h],[x,y+h]], sides=[[x+w/2,y],[x+w,y+h/2],[x+w/2,y+h],[x,y+h/2]];
  c.fillStyle='#fff'; c.strokeStyle='#000'; c.lineWidth=1.5;
  for(var i=0;i<corners.length;i++){ var cp=corners[i]; c.beginPath(); c.rect(cp[0]-hs,cp[1]-hs,hs*2,hs*2); c.fill(); c.stroke(); }
  for(var j=0;j<sides.length;j++){ var sp=sides[j]; c.beginPath(); c.rect(sp[0]-hs,sp[1]-hs,hs*2,hs*2); c.fill(); c.stroke(); }
  var rx=x+w/2, ry=y-36; c.beginPath(); c.moveTo(x+w/2,y); c.lineTo(rx,ry); c.strokeStyle='rgba(0,0,0,.6)'; c.lineWidth=1; c.stroke();
  c.beginPath(); c.arc(rx,ry,9,0,Math.PI*2); c.fillStyle='#fff'; c.fill(); c.strokeStyle='#000'; c.stroke();
  if(b.tail.enabled){ var tipLocal={x:b.tail.lx,y:b.tail.ly}; c.beginPath(); c.arc(tipLocal.x,tipLocal.y,9,0,Math.PI*2); c.fillStyle='#8dd0ff'; c.fill(); c.strokeStyle='#083b5c'; c.stroke(); }
  c.restore();
}
function ptInRect(px,py,x,y,w,h){return px>=x&&py>=y&&px<=x+w&&py<=y+h}function hitTest(px,py){for(var i=state.bubbles.length-1;i>=0;i--){var b=state.bubbles[i],cx=b.x+b.w/2,cy=b.y+b.h/2,lp=invRotatePoint(px,py,cx,cy,deg2rad(b.rot)),x=-b.w/2,y=-b.h/2,w=b.w,h=b.h,hs=12,corners=[[x,y,'tl'],[x+w,y,'tr'],[x+w,y+h,'br'],[x,y+h,'bl']];for(var j=0;j<corners.length;j++){var cx2=corners[j][0],cy2=corners[j][1],code=corners[j][2];if(ptInRect(lp.x,lp.y,cx2-hs,cy2-hs,hs*2,hs*2))return{b:b,part:'corner',code:code}}var rx=x+w/2,ry=y-36,d=Math.hypot(lp.x-rx,lp.y-ry);if(d<=10)return{b:b,part:'rotate'};if(b.tail.enabled){var tip={x:b.tail.lx,y:b.tail.ly};if(Math.hypot(lp.x-tip.x,lp.y-tip.y)<=10)return{b:b,part:'tail'}}if(ptInRect(lp.x,lp.y,x,y,w,h))return{b:b,part:'move'}}return null}function setCursorFromHit(hit){if(!hit){canvas.style.cursor='default';return}if(hit.part==='move'){canvas.style.cursor='default';return}if(hit.part==='rotate')canvas.style.cursor='grab';else if(hit.part==='corner')canvas.style.cursor='nwse-resize';else if(hit.part==='tail')canvas.style.cursor='crosshair'}canvas.addEventListener('pointermove',function(e){if(state.activePointer!==null)return;var p=toCanvasPoint(e),hit=hitTest(p.x,p.y);changedDuringDrag=false;setCursorFromHit(hit)});function toCanvasPoint(e){var r=canvas.getBoundingClientRect(),sx=canvas.width/r.width,sy=canvas.height/r.height;return{x:(e.clientX-r.left)*sx,y:(e.clientY-r.top)*sy}}function cssScale(){var r=inner.getBoundingClientRect();return{sx:r.width/canvas.width,sy:r.height/canvas.height}}canvas.addEventListener('pointerdown',function(e){if(e.button!==0)return;canvas.focus();var p=toCanvasPoint(e),hit=hitTest(p.x,p.y);if(hit){state.selectedId=hit.b.id;updatePanels();draw();if(hit.part!=='move'){var b=hit.b;state.drag={mode:hit.part,code:hit.code,start:{px:p.x,py:p.y,bx:b.x,by:b.y,bw:b.w,bh:b.h,br:b.rot,cx:b.x+b.w/2,cy:b.y+b.h/2,a0:Math.atan2(p.y-(b.y+b.h/2),p.x-(b.x+b.w/2))}};state.activePointer=e.pointerId;canvas.setPointerCapture(e.pointerId);canvas.style.cursor='grabbing'}e.preventDefault()}else{state.selectedId=null;state.drag=null;updatePanels();draw()}});function endPointer(e){if(e.pointerId===state.activePointer){canvas.releasePointerCapture(e.pointerId);state.activePointer=null;state.drag=null;canvas.style.cursor='default';if(changedDuringDrag){commitHistory();changedDuringDrag=false;}}}canvas.addEventListener('pointerup',endPointer);canvas.addEventListener('pointercancel',endPointer);canvas.addEventListener('pointermove',function(e){if(state.activePointer===null||e.pointerId!==state.activePointer)return;var p=toCanvasPoint(e),b=getSelected();if(!b)return;var d=state.drag||{},m=d.mode,code=d.code,s=d.start;if(!m)return;if(m==='corner'){
      var hw=s.bw/2, hh=s.bh/2, ox=0, oy=0;
      if(code==='tl'){ox= hw; oy= hh}
      if(code==='tr'){ox=-hw; oy= hh}
      if(code==='br'){ox=-hw; oy=-hh}
      if(code==='bl'){ox= hw; oy=-hh}
      var ang=deg2rad(s.br);
      var pv=rotatePoint(s.cx+ox, s.cy+oy, s.cx, s.cy, ang);
      var cxW=(pv.x+p.x)/2, cyW=(pv.y+p.y)/2;
      var pl=invRotatePoint(pv.x,pv.y,cxW,cyW,ang);
      var dl=invRotatePoint(p.x,p.y,cxW,cyW,ang);
      var w=Math.max(40, Math.abs(dl.x-pl.x));
      var h=Math.max(40, Math.abs(dl.y-pl.y));
      if(e.shiftKey){var ar=s.bw/s.bh; if(w/h>ar) h=w/ar; else w=h*ar}
      b.w=w; b.h=h; b.x=cxW-w/2; b.y=cyW-h/2;
    } else if(m==='rotate'){ var ang=Math.atan2(p.y - s.cy, p.x - s.cx), base=(s.a0!=null?s.a0:Math.atan2(s.py - s.cy, s.px - s.cx)), deg=s.br + (ang - base)*180/Math.PI; if(e.shiftKey){deg=Math.round(deg/15)*15} b.rot=Math.round(deg); }else if(m==='tail'){var cx3=b.x+b.w/2,cy3=b.y+b.h/2,lp2=invRotatePoint(p.x,p.y,cx3,cy3,deg2rad(b.rot)),x2=-b.w/2,y2=-b.h/2,w2=b.w,h2=b.h,attach=nearestPointOnRect(x2,y2,w2,h2,lp2.x,lp2.y),ang2=Math.atan2(lp2.y-attach.y,lp2.x-attach.x);if(e.shiftKey){ang2=Math.round(ang2/(Math.PI/12))*(Math.PI/12)}var L=clamp(Math.hypot(lp2.y-attach.y,lp2.x-attach.x),10,2e3);b.tail.lx=attach.x+Math.cos(ang2)*L;b.tail.ly=attach.y+Math.sin(ang2)*L;b.tail.length=L}changedDuringDrag=true;draw();updatePanels()});function isTypingTarget(el){if(!el)return false;var t=(el.tagName||'').toLowerCase();if(t==='input'||t==='textarea')return true;if(el.isContentEditable)return true;if(el.closest){var hit=el.closest('input, textarea, [contenteditable="true"], [contenteditable=""]');if(hit)return true}return false}function handleKeydown(e){if(isTypingTarget(e.target))return;var b=getSelected();if(e.key==='Delete'||e.key==='Backspace'){if(b){var id=b.id;removeSelected();removeAnchor(id);draw();commitHistory()}e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='d'){if(b){duplicateSelected();draw()}e.preventDefault();return}if(e.key.toLowerCase()==='s'){addBubble('speech');return}if(e.key.toLowerCase()==='t'){addBubble('thought');return}if(e.key.toLowerCase()==='h'){addBubble('shout');return}if(b){var step=e.shiftKey?10:2;if(e.key==='ArrowLeft'){b.x-=step;draw();updatePanels();clearTimeout(keyCommitTimer);keyCommitTimer=setTimeout(function(){commitHistory()},300);e.preventDefault();return}if(e.key==='ArrowRight'){b.x+=step;draw();updatePanels();clearTimeout(keyCommitTimer);keyCommitTimer=setTimeout(function(){commitHistory()},300);e.preventDefault();return}if(e.key==='ArrowUp'){b.y-=step;draw();updatePanels();clearTimeout(keyCommitTimer);keyCommitTimer=setTimeout(function(){commitHistory()},300);e.preventDefault();return}if(e.key==='ArrowDown'){b.y+=step;draw();updatePanels();clearTimeout(keyCommitTimer);keyCommitTimer=setTimeout(function(){commitHistory()},300);e.preventDefault();return}}}window.addEventListener('keydown',handleKeydown);
function handleShortcut(e){var k=e.key.toLowerCase(),mod=e.ctrlKey||e.metaKey;if(mod&&k==='z'&&!e.shiftKey){undo();e.preventDefault()}else if((mod&&k==='z'&&e.shiftKey)||(mod&&k==='y')){redo();e.preventDefault()}else if(mod&&k==='c'&&!isTypingTarget(e.target)){copySelected();e.preventDefault()}else if(mod&&k==='v'&&!isTypingTarget(e.target)){pasteClipboard();e.preventDefault()}}
window.addEventListener('keydown',handleShortcut);function addBubble(t){var b=makeBubble(t);state.bubbles.push(b);state.selectedId=b.id;updatePanels();draw();refreshBubblePicker();refreshPickerSelection();commitHistory()}function indexOfSelected(){for(var i=0;i<state.bubbles.length;i++)if(state.bubbles[i].id===state.selectedId)return i;return -1}function getSelected(){for(var i=0;i<state.bubbles.length;i++)if(state.bubbles[i].id===state.selectedId)return state.bubbles[i];return null}function removeSelected(){var idx=indexOfSelected();if(idx>=0){var removed=state.bubbles.splice(idx,1)[0];state.selectedId=null;updatePanels();refreshBubblePicker();refreshPickerSelection();if(removed)removeAnchor(removed.id)}}function duplicateSelected(){var b=getSelected();if(!b)return;var c=JSON.parse(JSON.stringify(b));c.id=uid();state.bubbles.push(c);state.selectedId=c.id;updatePanels();draw();refreshBubblePicker();refreshPickerSelection();commitHistory()}$('#addSpeech').onclick=function(){addBubble('speech')};$('#addThought').onclick=function(){addBubble('thought')};$('#addShout').onclick=function(){addBubble('shout')};$('#btnNewBubble').onclick=function(){addBubble('speech')};$('#btnUp').onclick=function(){var i=indexOfSelected();if(i>=0&&i<state.bubbles.length-1){var b=state.bubbles.splice(i,1)[0];state.bubbles.splice(i+1,0,b);draw();updatePanels();commitHistory()}};$('#btnDown').onclick=function(){var i=indexOfSelected();if(i>0){var b=state.bubbles.splice(i,1)[0];state.bubbles.splice(i-1,0,b);draw();updatePanels();commitHistory()}};$('#btnDuplicate').onclick=function(){duplicateSelected()};$('#btnDelete').onclick=function(){var b=getSelected();if(b){var id=b.id;removeSelected();removeAnchor(id);draw();commitHistory()}};var picker=$('#bubblePicker');function refreshBubblePicker(){picker.innerHTML=state.bubbles.map(function(b,i){return'<option value="'+b.id+'">#'+(i+1)+': '+((b.text||'').slice(0,18).replace(/[&<>"']/g,function(m){return{"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]}))+'</option>'}).join('');if(!state.selectedId&&state.bubbles[0])state.selectedId=state.bubbles[0].id}function refreshPickerSelection(){if(!picker)return;picker.value=state.selectedId||''}picker.onchange=function(){state.selectedId=picker.value||null;updatePanels();draw()};var selPanel=$('#selPanel'),movePanel=$('#movePanel'),sizePanel=$('#sizePanel');function updatePanels(){var b=getSelected();selPanel.style.display=b?'block':'none';movePanel.style.display=b?'block':'none';if(sizePanel) sizePanel.style.display=b?'block':'none';setMoveInputs(b);if(b){$('#propType').value=b.type;$('#propText').value=b.text;$('#propFont').value=b.font;$('#propFontSize').value=b.fontSize;$('#propAlign').value=b.align;$('#propFill').value=b.fill;$('#propStroke').value=b.stroke;$('#propStrokeW').value=b.strokeW;$('#propTextFill').value=b.textFill;$('#propTextStroke').value=b.textStroke;$('#propTextStrokeW').value=b.textStrokeW;$('#propTailEnabled').checked=b.tail.enabled;$('#propTailW').value=b.tail.width;$('#propTailL').value=Math.round(b.tail.length||80);$('#propPadding').value=b.padding;$('#propRot').value=b.rot}syncAllAnchors()}function setMoveInputs(b){$('#propX').value=b?Math.round(b.x):'';$('#propY').value=b?Math.round(b.y):'';$('#propW').value=b?Math.round(b.w):'';$('#propH').value=b?Math.round(b.h):''}function bindProp(id,fn){var el=$(id);el.addEventListener('input',function(){var b=getSelected();if(!b)return;fn(b,el);draw();updatePanels();commitHistory()})}[['#propType',function(b,e){b.type=e.value}],['#propText',function(b,e){b.text=e.value}],['#propFont',function(b,e){b.font=e.value}],['#propFontSize',function(b,e){b.fontSize=parseInt(e.value||40,10)}],['#propAlign',function(b,e){b.align=e.value}],['#propFill',function(b,e){b.fill=e.value}],['#propStroke',function(b,e){b.stroke=e.value}],['#propStrokeW',function(b,e){b.strokeW=parseFloat(e.value||0)}],['#propTextFill',function(b,e){b.textFill=e.value}],['#propTextStroke',function(b,e){b.textStroke=e.value}],['#propTextStrokeW',function(b,e){b.textStrokeW=parseFloat(e.value||0)}],['#propTailEnabled',function(b,e){b.tail.enabled=e.checked}],['#propTailW',function(b,e){b.tail.width=parseFloat(e.value||20)}],['#propTailL',function(b,e){var L=Math.max(5,parseFloat(e.value||80)),x=-b.w/2,y=-b.h/2,w=b.w,h=b.h,att=nearestPointOnRect(x,y,w,h,b.tail.lx,b.tail.ly),ang=Math.atan2(b.tail.ly-att.y,b.tail.lx-att.x);b.tail.lx=att.x+Math.cos(ang)*L;b.tail.ly=att.y+Math.sin(ang)*L;b.tail.length=L}],['#propPadding',function(b,e){b.padding=parseFloat(e.value||18)}],['#propRot',function(b,e){b.rot=parseFloat(e.value||0)}],['#propX',function(b,e){b.x=parseFloat(e.value||0)}],['#propY',function(b,e){b.y=parseFloat(e.value||0)}],['#propW',function(b,e){b.w=Math.max(40,parseFloat(e.value||40))}],['#propH',function(b,e){b.h=Math.max(40,parseFloat(e.value||40))}]].forEach(function(p){bindProp(p[0],p[1])});$('#fileImage').addEventListener('change',function(e){var f=e.target.files&&e.target.files[0];if(f)loadBackgroundFile(f);e.target.value=''});wrap.addEventListener('dragover',function(e){e.preventDefault();if(dropHint)dropHint.style.opacity='1'});wrap.addEventListener('dragleave',function(){if(dropHint)dropHint.style.opacity='0.7'});wrap.addEventListener('drop',function(e){e.preventDefault();var f=e.dataTransfer.files&&e.dataTransfer.files[0];if(f&&f.type&&f.type.indexOf('image/')===0)loadBackgroundFile(f);if(dropHint)dropHint.style.opacity='0.7'});function loadBackgroundFile(file){var img=new Image(),fr=new FileReader();fr.onload=function(){img.onload=function(){setBackground(img, fr.result)};img.src=fr.result};fr.readAsDataURL(file)}function setBackground(img,src,sup){state.bg.image=img; if(src) state.bg.imageSrc=src;state.bg.w=img.naturalWidth;state.bg.h=img.naturalHeight;resizeCanvasToBackground();statusEl.textContent=img.naturalWidth+'×'+img.naturalHeight;draw();if(!sup) commitHistory();try{if(dropHint&&dropHint.parentNode){dropHint.parentNode.removeChild(dropHint);dropHint=null}}catch(_e){}}function resizeCanvasToBackground(){var w=state.bg.w,h=state.bg.h;canvas.width=w;canvas.height=h;ov.width=w;ov.height=h;inner.style.width=w+'px';inner.style.height=h+'px';fitToViewport()}function fitToViewport(){var r=scroller.getBoundingClientRect(),zm=Math.min(r.width/state.bg.w,r.height/state.bg.h,1);setZoom(zm);centerScroll();drawRulers();}function setZoom(z){state.zoom=z;inner.style.width=state.bg.w*z+'px';inner.style.height=state.bg.h*z+'px';var zl=Math.round(z*100),zEl=$('#zoom'),zlEl=$('#zoomLabel');if(zEl)zEl.value=zl;if(zlEl)zlEl.textContent=zl+'%';syncAllAnchors();drawRulers();}var zoomEl=$('#zoom');if(zoomEl)zoomEl.addEventListener('input',function(e){setZoom(parseInt(e.target.value,10)/100);drawRulers();});function centerScroll(){var r=scroller.getBoundingClientRect(),iw=inner.getBoundingClientRect().width,ih=inner.getBoundingClientRect().height;scroller.scrollLeft=(iw-r.width)/2;scroller.scrollTop=(ih-r.height)/2;syncAllAnchors()}$('#bgColor').addEventListener('input',function(e){state.bg.color=e.target.value;draw();commitHistory()});$('#bgOpacity').addEventListener('input',function(e){state.bg.opacity=parseFloat(e.target.value||1);draw();commitHistory()});function exportComposite(fmt){var w=state.bg.w,h=state.bg.h,out=document.createElement('canvas');out.width=w;out.height=h;var c=out.getContext('2d');c.fillStyle=state.bg.color;c.globalAlpha=state.bg.opacity;c.fillRect(0,0,w,h);c.globalAlpha=1;if(state.bg.image)c.drawImage(state.bg.image,0,0,w,h);for(var i=0;i<state.bubbles.length;i++)drawBubble(c,state.bubbles[i]);var mime=fmt==='jpg'?'image/jpeg':'image/png',q=fmt==='jpg'?0.92:undefined,url=out.toDataURL(mime,q),a=document.createElement('a');a.href=url;a.download='bubbles.'+(fmt==='jpg'?'jpg':'png');a.click()}function saveProject(){var data={bg:{color:state.bg.color,opacity:state.bg.opacity,w:state.bg.w,h:state.bg.h,image:state.bg.image?(function(i){var c=document.createElement('canvas');c.width=i.naturalWidth;c.height=i.naturalHeight;c.getContext('2d').drawImage(i,0,0);return c.toDataURL('image/png')})(state.bg.image):null},bubbles:state.bubbles};var blob=new Blob([JSON.stringify(data)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='bubble_project.json';a.click();}
function openProject(){var inp=document.createElement('input');inp.type='file';inp.accept='application/json';inp.onchange=function(){var f=inp.files[0];if(!f)return;var fr=new FileReader();fr.onload=function(){try{restoreProject(JSON.parse(fr.result))}catch(err){alert('Invalid project file')}};fr.readAsText(f)};inp.click()}function restoreProject(d, resetHistory){ if(resetHistory===undefined) resetHistory=true; state.bubbles=d.bubbles||[];for(var i=0;i<state.bubbles.length;i++)ensureTailLocal(state.bubbles[i]);state.selectedId=(state.bubbles[0]&&state.bubbles[0].id)||null;state.bg.color=(d.bg&&d.bg.color)||'#000';state.bg.opacity=(d.bg&&d.bg.opacity!=null?d.bg.opacity:1);var w=(d.bg&&d.bg.w)||1280,h=(d.bg&&d.bg.h)||720;if(d.bg&&d.bg.image){state.bg.imageSrc=d.bg.image;var img=new Image();img.onload=function(){setBackground(img, d.bg.image, true);draw()};img.src=d.bg.image}else{state.bg.image=null;state.bg.w=w;state.bg.h=h;resizeCanvasToBackground();draw()}updatePanels();refreshBubblePicker();refreshPickerSelection();rebuildAnchors();if(resetHistory){history.past=[takeSnapshot()];history.future=[]}}function ensureTailLocal(b){if(!b.tail)b.tail={enabled:true,lx:0,ly:b.h/2+80,width:40,length:80};if(b.tail.lx==null||b.tail.ly==null){var cx=b.x+b.w/2,cy=b.y+b.h/2,tx=b.tail.x!=null?b.tail.x:b.x+b.w/2,ty=b.tail.y!=null?b.tail.y:b.y+b.h/2+80,loc=invRotatePoint(tx,ty,cx,cy,deg2rad(b.rot));b.tail.lx=loc.x-cx;b.tail.ly=loc.y-cy;var x=-b.w/2,y=-b.h/2,w=b.w,h=b.h,att=nearestPointOnRect(x,y,w,h,b.tail.lx,b.tail.ly),len=Math.hypot(b.tail.ly-att.y,b.tail.lx-att.x);if(!(b.tail.length>0))b.tail.length=len}}function ensureAnchor(b){
  if(anchors[b.id]) return anchors[b.id].el;
  var el=document.createElement('div');
  el.className='hitAnchor';
  el.setAttribute('data-id',b.id);
  // Pointer down: decide whether this is move, resize-corner, rotate, or tail based on hit test
  el.addEventListener('pointerdown',function(e){
    if(e.button!==0) return;
    // if a corner button was clicked, let that handler run exclusively
    if(e.target && e.target.classList && (e.target.classList.contains('corner-btn')||e.target.classList.contains('rot-btn')||e.target.classList.contains('side-btn'))) return;
    state.selectedId=b.id; updatePanels(); draw();
    var p=toCanvasPoint(e), hit=hitTest(p.x,p.y);
    changedDuringDrag=false;
    // If we clicked a handle on this same bubble, start a drag of that type
    if(hit && hit.b && hit.b.id===b.id && hit.part!=='move'){
      state.drag={mode:hit.part,code:hit.code,start:{px:p.x,py:p.y,bx:b.x,by:b.y,bw:b.w,bh:b.h,br:b.rot,cx:b.x+b.w/2,cy:b.y+b.h/2}};
      state.activePointer=e.pointerId;
      el.setPointerCapture(e.pointerId);
      canvas.style.cursor='grabbing';
    }else{
      // Default: MOVE (like before) using CSS scale conversion
      var s=cssScale();
      anchors[b.id].pointerId=e.pointerId;
      anchors[b.id].dragStart={x:e.clientX,y:e.clientY,bx:b.x,by:b.y,sx:s.sx,sy:s.sy};
      el.setPointerCapture(e.pointerId);
    }
    e.preventDefault();
  });
  // Pointer move: if we started a handle drag, reuse the same math as canvas; otherwise do MOVE
  el.addEventListener('pointermove',function(e){
    // If this pointer matches an active handle drag
    if(state.activePointer===e.pointerId && state.drag && state.drag.mode){
      var p=toCanvasPoint(e), m=state.drag.mode, code=state.drag.code, s=state.drag.start, bb=getSelected();
      if(!bb) return;
      if(m==='corner'){
      var cx=s.cx, cy=s.cy,
            lp0=invRotatePoint(s.px,s.py,cx,cy,deg2rad(s.br)),
            lp =invRotatePoint(p.x ,p.y ,cx,cy,deg2rad(s.br)),
            x=-s.bw/2, y=-s.bh/2, w=s.bw, h=s.bh,
            dx=lp.x-lp0.x, dy=lp.y-lp0.y, keep=e.shiftKey;
        if(code==='tl'){x+=dx;y+=dy;w-=dx;h-=dy}
        if(code==='tr'){y+=dy;w+=dx;h-=dy}
        if(code==='br'){w+=dx;h+=dy}
        if(code==='bl'){x+=dx;w-=dx;h+=dy}
        if(keep){var ar=s.bw/s.bh; if(Math.abs(w/h-ar)>1e-4){ if(Math.abs(dx)>Math.abs(dy)){ h=w/ar; y=-h/2 } else { w=h*ar; x=-w/2 } } }
        bb.w=Math.max(40,w); bb.h=Math.max(40,h); bb.x=cx+x; bb.y=cy+y;
      }else if(m==='rotate'){
        var cx2=bb.x+bb.w/2, cy2=bb.y+bb.h/2, ang=Math.atan2(p.y-cy2,p.x-cx2);
        bb.rot=Math.round(ang*180/Math.PI+90)-90;
      }else if(m==='tail'){
        var cx3=bb.x+bb.w/2, cy3=bb.y+bb.h/2,
            lp2=invRotatePoint(p.x,p.y,cx3,cy3,deg2rad(bb.rot)),
            x2=-bb.w/2, y2=-bb.h/2, w2=bb.w, h2=bb.h,
            attach=nearestPointOnRect(x2,y2,w2,h2,lp2.x,lp2.y),
            ang2=Math.atan2(lp2.y-attach.y,lp2.x-attach.x);
        if(e.shiftKey){ang2=Math.round(ang2/(Math.PI/12))*(Math.PI/12)}
        var L=clamp(Math.hypot(lp2.y-attach.y,lp2.x-attach.x),10,2e3);
        bb.tail.lx=attach.x+Math.cos(ang2)*L; bb.tail.ly=attach.y+Math.sin(ang2)*L; bb.tail.length=L;
      }
      changedDuringDrag=true; draw(); updatePanels();
      return;
    }
    // Else, MOVE drag via overlay anchor
    var rec=anchors[b.id];
    if(!rec||rec.pointerId===null||e.pointerId!==rec.pointerId) return;
    var d=rec.dragStart, dx=e.clientX-d.x, dy=e.clientY-d.y,
        dxC=dx/d.sx, dyC=dy/d.sy;
    b.x=d.bx+dxC; b.y=d.by+dyC; changedDuringDrag=true;
    draw(); updatePanels();
  });
  function endAP(e){
    // End any handle drag stored in state
    if(state.activePointer===e.pointerId){
      state.activePointer=null; state.drag=null; canvas.style.cursor='default';
      if(changedDuringDrag){ commitHistory(); changedDuringDrag=false; }
    }
    // End MOVE drag for this anchor
    var rec=anchors[b.id];
    if(rec && e.pointerId===rec.pointerId){
      el.releasePointerCapture(e.pointerId);
      rec.pointerId=null; rec.dragStart=null;
      if(changedDuringDrag){ commitHistory(); changedDuringDrag=false; }
    }
  }
  el.addEventListener('pointerup',endAP);
  el.addEventListener('pointercancel',endAP);
  var wrap=document.createElement('div');
  wrap.className='corner-wrap';
  ['tl','tr','br','bl'].forEach(function(code){
    var btn=document.createElement('div');
    btn.className='corner-btn';
    btn.setAttribute('data-c',code);
    if(code==='tl'){btn.style.left='0%'; btn.style.top='0%'}
    if(code==='tr'){btn.style.left='100%'; btn.style.top='0%'}
    if(code==='br'){btn.style.left='100%'; btn.style.top='100%'}
    if(code==='bl'){btn.style.left='0%'; btn.style.top='100%'}
    btn.addEventListener('pointerdown',function(ev){
      if(ev.button!==0) return;
      ev.stopPropagation(); ev.preventDefault();
      state.selectedId=b.id; updatePanels(); draw();
      var p=toCanvasPoint(ev);
      state.drag={mode:'corner',code:code,start:{px:p.x,py:p.y,bx:b.x,by:b.y,bw:b.w,bh:b.h,br:b.rot,cx:b.x+b.w/2,cy:b.y+b.h/2}};
      state.activePointer=ev.pointerId;
      btn.setPointerCapture(ev.pointerId);
      changedDuringDrag=false;
    });
    btn.addEventListener('pointermove',function(ev){ ev.stopPropagation();
      if(state.activePointer!==ev.pointerId || !state.drag || state.drag.mode!=='corner') return;
      var s=state.drag.start, bb=getSelected(); if(!bb) return;
      var hw=s.bw/2, hh=s.bh/2, ox=0, oy=0;
      if(code==='tl'){ox= hw; oy= hh}
      if(code==='tr'){ox=-hw; oy= hh}
      if(code==='br'){ox=-hw; oy=-hh}
      if(code==='bl'){ox= hw; oy=-hh}
      var ang=deg2rad(s.br); var pv=rotatePoint(s.cx+ox, s.cy+oy, s.cx, s.cy, ang);
      var p=toCanvasPoint(ev), cxW=(pv.x+p.x)/2, cyW=(pv.y+p.y)/2;
      var pl=invRotatePoint(pv.x,pv.y,cxW,cyW,ang), dl=invRotatePoint(p.x,p.y,cxW,cyW,ang);
      var w=Math.max(40, Math.abs(dl.x-pl.x)), h=Math.max(40, Math.abs(dl.y-pl.y));
      if(ev.shiftKey){var ar=s.bw/s.bh; if(w/h>ar) h=w/ar; else w=h*ar}
      bb.w=w; bb.h=h; bb.x=cxW-w/2; bb.y=cyW-h/2; changedDuringDrag=true; draw(); updatePanels();
    });
    function end(ev){
      ev.stopPropagation();
      if(state.activePointer===ev.pointerId){
        try{btn.releasePointerCapture(ev.pointerId)}catch(_e){}
        state.activePointer=null; state.drag=null; canvas.style.cursor='default';
        if(changedDuringDrag){ commitHistory(); changedDuringDrag=false; }
      }
    }
    btn.addEventListener('pointerup',end); btn.addEventListener('pointercancel',end);
    wrap.appendChild(btn);
  });
  // side buttons (mid-edges)
  ;(function(){
    [['t','50%','0%'],['r','100%','50%'],['b','50%','100%'],['l','0%','50%']].forEach(function(ent){
      var code=ent[0], sx=ent[1], sy=ent[2];
      var sb=document.createElement('div');
      sb.className='side-btn'; sb.setAttribute('data-s',code);
      sb.style.left=sx; sb.style.top=sy;
      sb.addEventListener('pointerdown',function(ev){
        if(ev.button!==0) return; ev.stopPropagation(); ev.preventDefault();
        state.selectedId=b.id; updatePanels(); draw();
        var p=toCanvasPoint(ev);
        state.drag={mode:'side',code:code,start:{px:p.x,py:p.y,bx:b.x,by:b.y,bw:b.w,bh:b.h,br:b.rot,cx:b.x+b.w/2,cy:b.y+b.h/2}};
        state.activePointer=ev.pointerId; sb.setPointerCapture(ev.pointerId); changedDuringDrag=false;
      });
      sb.addEventListener('pointermove',function(ev){
        ev.stopPropagation(); if(state.activePointer!==ev.pointerId||!state.drag||state.drag.mode!=='side') return;
        var p=toCanvasPoint(ev), s=state.drag.start, bb=getSelected(); if(!bb) return;
        var ang=deg2rad(s.br), ax,ay,ox=0,oy=0;
        if(code==='l'){ax=Math.cos(ang);ay=Math.sin(ang);ox=+s.bw/2;}
        else if(code==='r'){ax=Math.cos(ang);ay=Math.sin(ang);ox=-s.bw/2;}
        else if(code==='t'){ax=-Math.sin(ang);ay=Math.cos(ang);oy=+s.bh/2;}
        else {ax=-Math.sin(ang);ay=Math.cos(ang);oy=-s.bh/2;}
        var pv=rotatePoint(s.cx+ox, s.cy+oy, s.cx, s.cy, ang);
        var vx=p.x-pv.x, vy=p.y-pv.y; var d=vx*ax+vy*ay;
        var cxW=pv.x+ax*(d/2), cyW=pv.y+ay*(d/2);
        var w=s.bw, h=s.bh; if(code==='l'||code==='r'){ w=Math.max(40, Math.abs(d)); } else { h=Math.max(40, Math.abs(d)); }
        bb.w=w; bb.h=h; bb.x=cxW-w/2; bb.y=cyW-h/2; changedDuringDrag=true; draw(); updatePanels();
      });
      function endS(ev){ ev.stopPropagation(); if(state.activePointer===ev.pointerId){ try{sb.releasePointerCapture(ev.pointerId)}catch(_e){} state.activePointer=null; state.drag=null; canvas.style.cursor='default'; if(changedDuringDrag){commitHistory();changedDuringDrag=false;} } }
      sb.addEventListener('pointerup',endS); sb.addEventListener('pointercancel',endS);
      wrap.appendChild(sb);
    });
  })();
  // rotate button (top-center, offset above the box)
  var rbtn=document.createElement('div');
  rbtn.className='rot-btn';
  rbtn.addEventListener('pointerdown',function(ev){
    if(ev.button!==0) return; ev.stopPropagation(); ev.preventDefault();
    state.selectedId=b.id; updatePanels(); draw();
    var cx=b.x+b.w/2, cy=b.y+b.h/2, p=toCanvasPoint(ev), a0=Math.atan2(p.y-cy,p.x-cx); state.drag={mode:'rotate',code:'rot',start:{cx:cx,cy:cy,br:b.rot,a0:a0,px:p.x,py:p.y}};
    state.activePointer=ev.pointerId; rbtn.setPointerCapture(ev.pointerId); changedDuringDrag=false;
  });
  rbtn.addEventListener('pointermove',function(ev){
    ev.stopPropagation(); if(state.activePointer!==ev.pointerId||!state.drag||state.drag.mode!=='rotate') return;
    var bb=getSelected(); if(!bb) return; var p=toCanvasPoint(ev), s=state.drag.start;
    var ang=Math.atan2(p.y - s.cy, p.x - s.cx), base=(s.a0!=null?s.a0:Math.atan2((s.py||0) - s.cy, (s.px||0) - s.cx)), deg=s.br + (ang - base)*180/Math.PI;
    if(ev.shiftKey){deg=Math.round(deg/15)*15}
    b.rot=Math.round(deg); changedDuringDrag=true; draw(); updatePanels();
  });
  function endR(ev){ ev.stopPropagation(); if(state.activePointer===ev.pointerId){ try{rbtn.releasePointerCapture(ev.pointerId)}catch(_e){} state.activePointer=null; state.drag=null; canvas.style.cursor='default'; if(changedDuringDrag){commitHistory(); changedDuringDrag=false;} } }
  rbtn.addEventListener('pointerup',endR); rbtn.addEventListener('pointercancel',endR);
  wrap.appendChild(rbtn);
  el.appendChild(wrap);
  anchorsRoot.appendChild(el);
  anchors[b.id]={el:el,wrap:wrap,rotBtn:rbtn,pointerId:null,dragStart:null};
  return el;
}
function removeAnchor(id){if(anchors[id]){try{anchorsRoot.removeChild(anchors[id].el)}catch(_e){}delete anchors[id]}}function syncAnchorFor(b){var el=ensureAnchor(b),s=cssScale();el.style.left=b.x*s.sx+'px';el.style.top=b.y*s.sy+'px';el.style.width=b.w*s.sx+'px';el.style.height=b.h*s.sy+'px';var rec=anchors[b.id];if(rec&&rec.wrap){rec.wrap.style.transform='translate(-50%,-50%) rotate('+b.rot+'deg)'; if(rec.rotBtn){rec.rotBtn.style.top='calc(0% - '+(36*s.sy)+'px)';}}}function syncAllAnchors(){var live={};for(var i=0;i<state.bubbles.length;i++){var bb=state.bubbles[i];live[bb.id]=true;syncAnchorFor(bb)}Object.keys(anchors).forEach(function(id){if(!live[id])removeAnchor(id)})}function rebuildAnchors(){anchorsRoot.innerHTML='';anchors={};for(var i=0;i<state.bubbles.length;i++)ensureAnchor(state.bubbles[i]);syncAllAnchors()}function draw(){clear(ctx);clear(octx);ctx.save();ctx.fillStyle=state.bg.color;ctx.globalAlpha=state.bg.opacity;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.globalAlpha=1;if(state.bg.image)ctx.drawImage(state.bg.image,0,0,canvas.width,canvas.height);ctx.restore();for(var i=0;i<state.bubbles.length;i++){ensureTailLocal(state.bubbles[i]);drawBubble(ctx,state.bubbles[i])}var sel=getSelected();if(sel)drawHandles(octx,sel)}

var history={past:[],future:[]},clipboard=null;
function takeSnapshot(){try{return JSON.stringify({bg:{color:state.bg.color,opacity:state.bg.opacity,w:state.bg.w,h:state.bg.h,imageSrc:state.bg.imageSrc||null},bubbles:state.bubbles});}catch(_e){return null}}
function applySnapshot(s){try{var d=JSON.parse(s);restoreProject({bg:{color:d.bg.color,opacity:d.bg.opacity,w:d.bg.w,h:d.bg.h,image:d.bg.imageSrc||null},bubbles:d.bubbles}, false);}catch(_e){}}
function commitHistory(){var snap=takeSnapshot();if(!snap)return;history.past.push(snap);history.future.length=0}
function undo(){if(history.past.length<2)return;history.future.push(history.past.pop());var prev=history.past[history.past.length-1];applySnapshot(prev)}
function redo(){if(!history.future.length)return;var next=history.future.pop();history.past.push(next);applySnapshot(next)}
function copySelected(){var b=getSelected();if(!b)return;clipboard=JSON.parse(JSON.stringify(b))}
function pasteClipboard(){if(!clipboard)return;var c=JSON.parse(JSON.stringify(clipboard));c.id=uid();c.x+=20;c.y+=20;state.bubbles.push(c);state.selectedId=c.id;refreshBubblePicker();refreshPickerSelection();updatePanels();draw();commitHistory()}
var changedDuringDrag=false,keyCommitTimer=null;

function setupHiDPI(c,w,h){var d=window.devicePixelRatio||1; c.width=Math.round(w*d); c.height=Math.round(h*d); c.style.width=w+'px'; c.style.height=h+'px'; var g=c.getContext('2d'); g.setTransform(d,0,0,d,0,0); return g;}
function sizeRulers(){ if(!rTop||!rLeft) return; var wb=wrap.getBoundingClientRect(); var fh = footer ? footer.getBoundingClientRect().height : 0; setupHiDPI(rTop, Math.max(0, wb.width-32), 24); setupHiDPI(rLeft, 32, Math.max(0, wb.height-24 - fh)); drawRulers(); }
function drawRulers(){ if(!rTop||!rLeft) return; var z=state.zoom, sl=scroller.scrollLeft, st=scroller.scrollTop; var gt=rTop.getContext('2d'), gl=rLeft.getContext('2d'); var dpr=window.devicePixelRatio||1; var w=rTop.width/dpr, hT=24, hL=rLeft.height/dpr; gt.clearRect(0,0,rTop.width,rTop.height); gl.clearRect(0,0,rLeft.width,rLeft.height); gt.fillStyle='#f8fafc'; gt.fillRect(0,0,w,hT); gl.fillStyle='#f8fafc'; gl.fillRect(0,0,32,hL); gt.strokeStyle='#d2d7e3'; gl.strokeStyle='#d2d7e3'; gt.beginPath(); gt.moveTo(0,hT-0.5); gt.lineTo(w,hT-0.5); gt.stroke(); gl.beginPath(); gl.moveTo(31.5,0); gl.lineTo(31.5,hL); gl.stroke(); var minStepPx=8, step=10; while(step*z<minStepPx) step*=2; var major=step*10; var startX=Math.floor((sl/z)/step)*step, endX=(sl+w)/z; gt.fillStyle='#111'; gt.font='10px Inter'; for(var x=startX; x<=endX; x+=step){ var xPx=x*z - sl; var isMajor = Math.abs((x/major)-Math.round(x/major))<1e-6; gt.beginPath(); gt.moveTo(Math.round(xPx)+0.5, hT-(isMajor?10:6)+0.5); gt.lineTo(Math.round(xPx)+0.5, hT+0.5); gt.strokeStyle='#9aa3b2'; gt.stroke(); if(isMajor){ gt.fillText(String(Math.round(x)), xPx+2, 11); } } var startY=Math.floor((st/z)/step)*step, endY=(st+hL)/z; gl.save(); gl.fillStyle='#111'; gl.font='10px Inter'; for(var y=startY; y<=endY; y+=step){ var yPx=y*z - st; var isMaj=Math.abs((y/major)-Math.round(y/major))<1e-6; gl.beginPath(); gl.moveTo(32-(isMaj?10:6)+0.5, Math.round(yPx)+0.5); gl.lineTo(32+0.5, Math.round(yPx)+0.5); gl.strokeStyle='#9aa3b2'; gl.stroke(); if(isMaj){ gl.save(); gl.translate(26, Math.round(yPx)+0.5); gl.rotate(-Math.PI/2); gl.textAlign='right'; gl.textBaseline='middle'; gl.fillText(String(Math.round(y)), 0, 0); gl.restore(); } } gl.restore(); }
function wheelZoom(e){ e.preventDefault(); var rect=inner.getBoundingClientRect(); var mx=e.clientX-rect.left, my=e.clientY-rect.top; var cx=mx/state.zoom, cy=my/state.zoom; var factor = e.deltaY<0 ? 1.1 : 0.9; var newZ = clamp(state.zoom*factor, 0.1, 3); if(newZ===state.zoom) return; setZoom(newZ); var srect=scroller.getBoundingClientRect(); scroller.scrollLeft = cx*newZ - (e.clientX - srect.left); scroller.scrollTop  = cy*newZ - (e.clientY - srect.top); drawRulers(); }resizeCanvasToBackground();setZoom(1);draw();refreshBubblePicker();refreshPickerSelection();updatePanels();rebuildAnchors();sizeRulers();drawRulers();commitHistory();scroller.addEventListener('scroll',drawRulers);window.addEventListener('resize',sizeRulers);scroller.addEventListener('wheel',wheelZoom,{passive:false});canvas.addEventListener('wheel',wheelZoom,{passive:false});var menus=[];function setupMenu(btnSel,dropSel){var btn=$(btnSel),drop=$(dropSel);function open(show){drop.hidden=!show;btn.setAttribute('aria-expanded',String(show))}btn.addEventListener('click',function(e){e.stopPropagation();var show=drop.hidden;closeAllMenus();open(show)});menus.push({btn:btn,drop:drop})}
function closeAllMenus(){for(var i=0;i<menus.length;i++){menus[i].drop.hidden=true;menus[i].btn.setAttribute('aria-expanded','false')}}
setupMenu('#menu-file','#dropdown-file');setupMenu('#menu-edit','#dropdown-edit');
// ----- Collapsible sections in right panel -----
function initCollapsers(){
  var secs=document.querySelectorAll('aside .section');
  secs.forEach(function(sec){
    var h=sec.querySelector('h3'); if(!h) return;
    var btn=document.createElement('button'); btn.type='button'; btn.className='tgl'; btn.textContent='▾'; btn.setAttribute('aria-expanded','true');
    h.prepend(btn);
    var key='sp.coll.'+(sec.id||h.textContent.trim());
    try{ if(localStorage.getItem(key)==='1'){ sec.classList.add('collapsed'); btn.textContent='▸'; btn.setAttribute('aria-expanded','false'); } }catch(_e){}
    function setCollapsed(v){ sec.classList.toggle('collapsed',v); btn.textContent=v?'▸':'▾'; btn.setAttribute('aria-expanded', v?'false':'true'); try{localStorage.setItem(key, v?'1':'0')}catch(_e){} }
    btn.addEventListener('click',function(ev){
      var v=!sec.classList.contains('collapsed');
      if(ev.altKey){
        document.querySelectorAll('aside .section').forEach(function(s){ var hh=s.querySelector('h3 .tgl'); if(hh){ s.classList.toggle('collapsed',v); hh.textContent=v?'▸':'▾'; hh.setAttribute('aria-expanded', v?'false':'true'); try{localStorage.setItem('sp.coll.'+(s.id||(s.querySelector('h3')?s.querySelector('h3').textContent.trim():'')), v?'1':'0')}catch(_e){} } });
      }
      setCollapsed(v);
    });
    btn.addEventListener('keydown',function(ev){ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); btn.click(); } });
  });
}
initCollapsers();
document.addEventListener('click',closeAllMenus);document.addEventListener('keydown',function(e){if(e.key==='Escape')closeAllMenus()});
function newProject(){state.bubbles=[];state.selectedId=null;state.bg.image=null;state.bg.imageSrc=null;state.bg.w=1280;state.bg.h=720;resizeCanvasToBackground();draw();refreshBubblePicker();refreshPickerSelection();updatePanels();rebuildAnchors();statusEl.textContent='New project';history.past=[];history.future=[];commitHistory()}function on(id,fn){var el=$(id);if(el)el.onclick=function(){closeAllMenus();fn()}}on('#mi-new',newProject);on('#mi-open',openProject);on('#mi-load-img',function(){var fi=$('#fileImage');if(fi)fi.click()});on('#mi-save',saveProject);on('#mi-exp-png',function(){exportComposite('png')});on('#mi-exp-jpg',function(){exportComposite('jpg')});on('#mi-undo',undo);
on('#mi-redo',redo);
on('#mi-copy',copySelected);
on('#mi-paste',pasteClipboard);
on('#mi-delete',function(){var b=getSelected();if(b){var id=b.id;removeSelected();removeAnchor(id);draw();commitHistory();}});
var appEl=document.querySelector('.app'), split=$('#splitter');
var AS_MIN=260, AS_MAX=900;
function setAsidePx(w){
  var appW=appEl.getBoundingClientRect().width;
  // keep at least 200px for canvas when very small windows
  var maxByApp=Math.max(AS_MIN, appW-200-6);
  w=clamp(Math.round(w), AS_MIN, Math.min(AS_MAX,maxByApp));
  appEl.style.gridTemplateColumns='1fr 6px '+w+'px';
  try{ localStorage.setItem('sp.asideW', String(w)); }catch(_e){}
}
(function initSplit(){
  var saved=0; try{ saved=parseInt(localStorage.getItem('sp.asideW')||'0',10)||0; }catch(_e){}
  setAsidePx(saved||360);
})();
split.addEventListener('pointerdown', function(e){
  if(e.button!==0) return;
  var startX=e.clientX;
  var startW=parseInt((localStorage.getItem('sp.asideW')||'360'),10);
  split.setPointerCapture(e.pointerId);
  function onMove(ev){
    var dx=ev.clientX-startX;           // right = +, left = -
    setAsidePx(startW - dx);            // drag right => aside smaller; drag left => aside larger
  }
  function onUp(){
    split.releasePointerCapture(e.pointerId);
    split.removeEventListener('pointermove', onMove);
    split.removeEventListener('pointerup', onUp);
    split.removeEventListener('pointercancel', onUp);
  }
  split.addEventListener('pointermove', onMove);
  split.addEventListener('pointerup', onUp);
  split.addEventListener('pointercancel', onUp);
});
split.addEventListener('dblclick', function(){ setAsidePx(360); });
window.addEventListener('resize', function(){
  var w=parseInt((localStorage.getItem('sp.asideW')||'360'),10);
  setAsidePx(w);
});})();</script></body></html>
